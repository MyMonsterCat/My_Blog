

# spring中的单例bean是线程安全的吗？

准确来说不是线程安全的。在spring框架中，默认Bean是单例，即整个程序上下文中只有一个实例，但是这个单例bean本身并不保证线程安全。
这是因为在多线程环境下，多个线程可能同时访问这个单例bean，并且可能在某个时刻修改这个bean的状态，导致数据不一致。
若要确保单例bean线程安全：
1.使用无状态bean
2.如果你的 Bean 必须有状态，那么你可以使用线程安全的数据结构（如 ConcurrentHashMap）或其他并发实用工具来管理状态。
3.使用Spring的@Scope注解，将bean设置为prototype，这样每次获取bean都会创建一个新的实例，从而避免了单例bean的线程安全问题。
4.使用ThreadLocal来存储每个线程的bean实例，这样每个线程都有自己的bean实例，从而避免了单例bean的线程安全问题。

# 什么是AOP

AOP（Aspect Oriented Programming）是一种编程思想，它允许我们分离关注点，将业务逻辑与非业务逻辑分离，从而提高代码的可维护性、可扩展性和可测试性。
AOP的实现原理是使用动态代理技术，通过代理的方式，在运行时动态地插入代码，从而实现对业务逻辑的增强。

# Spring中的事务是如何实现的
在Spring中，事务一般有声明式事务和编程式事务。事务是通过AOP实现的，在方法执行前加入开始事务，在方法执行后根据执行情况提交或回滚事务

# 事务失效的场景
> https://cloud.tencent.com/developer/article/1876768

事务不生效
3.非public修饰的方法，原因：源代码中进行了判定
4.方法被final修饰，原因：如果某个方法用final修饰了，那么在它的代理类中，就无法重写该方法，而添加事务功能。
同样的，如果某个方法是static的，同样无法通过动态代理，变成事务方法。
5.方法内部调用，例如AB都被 @Transactional修饰，A调用B。则B会失效。原因：B方法拥有事务的能力是因为spring aop生成代理了对象，方法A直接调用了this对象的方法，所以B方法不会生成事务
6.未被Spring管理的bean，原因：Spring AOP只对Spring管理的bean起作用。
7.多线程调用，原因：spring的事务是通过数据库连接来实现的，我们说的同一个事务，其实是指同一个数据库连接，只有拥有同一个数据库连接才能同时提交和回滚。如果在不同的线程，拿到的数据库连接肯定是不一样的，所以是不同的事务。
8.表不支持事务，原因：数据库引擎是myisam，其不支持事务
9.错误的切点表达式
事务不回滚
10.错误的事务传播特性
11.方法内异常被捕获，没有抛出
12.抛出了非检异常
其他
13.大事务导致回滚时间长等问题，减小锁粒度，事务中避免远程调用，避免一次性处理太多数据，异步处理
> https://mp.weixin.qq.com/s?__biz=MzkwNjMwMTgzMQ==&mid=2247490259&idx=1&sn=1dd11c5f49103ca303a61fc82ce406e0&source=41#wechat_redirect

# Spring的bean的生命周期



